{% extends "base.html" %}

{% block content %}
<style>
    /* --- CSS RIÊNG CHO ADMIN DASHBOARD --- */
    
    /* 1. Layout Container: Quan trọng để đè lên cấu trúc của base.html */
    .admin-wrapper {
        width: 100%;
        height: 100%;
        overflow-y: auto; /* Cho phép cuộn trang dọc */
        background-color: #f7fafc;
        padding: 40px 20px; /* Tạo khoảng thở xung quanh */
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    /* 2. Typography */
    h1, h2, h3 { color: #2d3748; margin-top: 0; }
    h2 { border-bottom: 2px solid #e2e8f0; padding-bottom: 15px; margin-bottom: 25px; font-size: 1.5rem; }
    .text-muted { color: #718096; font-size: 0.9rem; margin-bottom: 20px; }

    /* 3. Form Styling */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
    .form-control {
        width: 100%; padding: 10px; border: 1px solid #cbd5e0; border-radius: 6px; font-size: 1rem;
    }
    .form-control:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    
    .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover { background: #5a67d8; }
    .btn-danger { background: #e53e3e; color: white; padding: 6px 12px; font-size: 0.85rem; text-decoration: none; display: inline-block;}
    .btn-danger:hover { background: #c53030; }
    .btn-info { background: #3182ce; color: white; padding: 6px 12px; font-size: 0.85rem; text-decoration: none; display: inline-block; margin-right: 5px;}
    .btn-info:hover { background: #2b6cb0; }

    /* 4. Table Styling */
    .table-responsive { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th { background: #edf2f7; color: #4a5568; font-weight: 700; text-align: left; padding: 12px; border-bottom: 2px solid #cbd5e0; }
    td { padding: 12px; border-bottom: 1px solid #e2e8f0; color: #2d3748; }
    tr:hover { background-color: #f7fafc; }
    
    /* Utility */
    .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
    .badge-ai { background: #bee3f8; color: #2b6cb0; }
    .badge-gofai { background: #feebc8; color: #c05621; }

    /* Fix layout cho form upload và create */
    .panel { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-bottom: 30px; }
</style>

<div class="admin-wrapper">
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h1>Admin Dashboard</h1>
                <div class="text-muted">Quản lý học sinh và dữ liệu hệ thống</div>
            </div>
            <div>
                <a href="{{ url_for('main.export_chat_history') }}" class="btn btn-primary">
                    <i class="fas fa-download"></i> Xuất dữ liệu CSV
                </a>
            </div>
        </div>

        <div class="panel">
            <h2><i class="fas fa-user-plus"></i> Thêm Học Sinh Mới</h2>
            
            <div style="margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed #e2e8f0;">
                <h3>Upload danh sách (CSV)</h3>
                <p style="font-size: 0.9rem; color: #718096;">Format: <code>username,password,bot_type</code> (Ví dụ: HS01,123456,ai)</p>
                <form method="POST" enctype="multipart/form-data" style="display: flex; gap: 10px; align-items: center;">
                    {{ upload_form.hidden_tag() }}
                    {{ upload_form.csv_file(class="form-control", style="width: auto;") }}
                    {{ upload_form.submit(class="btn btn-primary", value="Upload CSV") }}
                </form>
            </div>

            <h3>Thêm thủ công</h3>
            <form method="POST">
                {{ user_form.hidden_tag() }}
                <div class="form-grid">
                    <div class="form-group">
                        <label>Tên đăng nhập (ID)</label>
                        {{ user_form.username(class="form-control", placeholder="Ví dụ: HS_NGUYEN_A") }}
                    </div>
                    <div class="form-group">
                        <label>Mật khẩu</label>
                        {{ user_form.password(class="form-control") }}
                    </div>
                    <div class="form-group">
                        <label>Loại Chatbot</label>
                        {{ user_form.bot_type(class="form-control") }}
                    </div>
                    <div class="form-group" style="display: flex; align-items: center; gap: 10px; padding-top: 25px;">
                        {{ user_form.is_admin() }} <label style="margin:0; cursor:pointer;" for="is_admin">Là Admin?</label>
                    </div>
                </div>
                {{ user_form.submit(class="btn btn-primary", value="Tạo tài khoản") }}
            </form>
        </div>

        <div class="panel">
            <h2><i class="fas fa-users"></i> Danh sách Học sinh</h2>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ID / Username</th>
                            <th>Loại Bot</th>
                            <th>Trạng thái</th>
                            <th style="width: 250px;">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td><b>{{ user.username }}</b></td>
                            <td>
                                {% if user.bot_type == 'ai' %}
                                    <span class="badge badge-ai">AI Coach</span>
                                {% else %}
                                    <span class="badge badge-gofai">Basic Bot</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if user.current_session_id %}
                                    <span style="color: #48bb78;"><i class="fas fa-circle" style="font-size: 8px;"></i> Đã học</span>
                                {% else %}
                                    <span style="color: #a0aec0;">Chưa học</span>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('main.view_chat_history', user_id=user.id) }}" class="btn-info" title="Xem lịch sử chat">
                                    <i class="fas fa-history"></i> Chat
                                </a>
                                <a href="{{ url_for('main.view_variable_logs', user_id=user.id) }}" class="btn-info" style="background: #805ad5;" title="Xem Log biến số">
                                    <i class="fas fa-code"></i> Logs
                                </a>
                                <a href="{{ url_for('main.delete_user', user_id=user.id) }}" class="btn-danger" onclick="return confirm('Bạn có chắc muốn xóa học sinh này? Dữ liệu sẽ mất hết.');">
                                    <i class="fas fa-trash"></i>
                                </a>
                                
                                <form action="{{ url_for('main.reset_student_password', user_id=user.id) }}" method="POST" style="display: inline-block; margin-top: 5px;">
                                    {{ reset_form.hidden_tag() }}
                                    <div style="display: flex; gap: 5px;">
                                        {{ reset_form.new_password(placeholder="Pass mới", style="width: 80px; padding: 4px; font-size: 0.8rem; border: 1px solid #e2e8f0; border-radius: 4px;") }}
                                        <button type="submit" style="background: none; border: 1px solid #cbd5e0; cursor: pointer; border-radius: 4px;" title="Lưu pass mới"><i class="fas fa-save"></i></button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" style="text-align: center; padding: 20px; color: #718096;">Chưa có dữ liệu học sinh.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
