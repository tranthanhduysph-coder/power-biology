{% extends "base.html" %}
{% block main_class %}no-scroll{% endblock %}
{% block content %}
<style>
/* CSS giữ nguyên như cũ */
.no-scroll { overflow: hidden; height: 100%; }
.chat-layout { display: flex; width: 100%; height: 100%; position: relative; }
.sidebar { width: 300px; background: #f8fafc; border-right: 1px solid #e2e8f0; display: flex; flex-direction: column; }
.chat-area { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; background: white; }
.chat-messages { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
.msg { display: flex; gap: 10px; margin-bottom: 15px; max-width: 85%; }
.msg.user { margin-left: auto; flex-direction: row-reverse; }
.msg .bubble { padding: 12px 16px; border-radius: 12px; line-height: 1.5; }
.msg.user .bubble { background: #667eea; color: white; }
.msg.assistant .bubble { background: #f1f5f9; color: #1a202c; }
.input-wrapper { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px; background: rgba(255,255,255,0.95); border-top: 1px solid #ddd; }
/* Mobile & Dark mode style giữ nguyên */
</style>

<div class="chat-layout">
    <div class="sidebar" id="sidebar">
        <div style="padding:20px; background:#2d3748; color:white;">
            <div id="timer" style="font-size:2rem; font-weight:bold; text-align:center;">00:00:00</div>
        </div>
        <div style="flex:1; overflow-y:auto; padding:10px;">
            <a href="{{ url_for('main.new_chat') }}" style="display:block; text-align:center; padding:10px; background:#667eea; color:white; border-radius:5px; margin-bottom:10px; text-decoration:none;">+ Chat Mới</a>
            {% for sess in session_list %}
            <a href="{{ url_for('main.switch_session', session_id=sess.id) }}" style="display:block; padding:10px; margin-bottom:5px; border:1px solid #ddd; border-radius:5px; text-decoration:none; color:#333; background:{{ '#ebf8ff' if sess.active else 'white' }};">
                {{ sess.name }}
            </a>
            {% endfor %}
        </div>
        <div style="padding:15px; border-top:1px solid #ddd;">
            <button id="theme-btn" style="width:100%; padding:8px;">Giao diện</button>
        </div>
    </div>

    <div class="chat-area">
        <div class="chat-messages" id="chat-box">
            {% for msg in chat_history %}
            <div class="msg {{ msg.sender }}">
                <div class="bubble">{{ msg.content | safe }}</div>
            </div>
            {% endfor %}
            <div class="msg assistant" id="typing" style="display:none;"><div class="bubble">...</div></div>
        </div>

        <div class="input-wrapper">
            <form id="chat-form" style="display:flex; gap:10px;">
                <input type="file" id="file-up" name="file" style="display:none;">
                <label for="file-up" style="padding:10px; background:#edf2f7; border-radius:50%; cursor:pointer;"><i class="fas fa-paperclip"></i></label>
                
                <input type="text" id="msg-input" name="user_input" style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;" placeholder="Nhập tin nhắn..." autocomplete="off">
                <button type="submit" style="padding:10px 20px; background:#667eea; color:white; border:none; border-radius:20px; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    chatBox.scrollTop = chatBox.scrollHeight;

    document.getElementById('chat-form').onsubmit = async (e) => {
        e.preventDefault();
        const input = document.getElementById('msg-input');
        const fileIn = document.getElementById('file-up');
        const text = input.value.trim();
        
        if (!text && !fileIn.files[0]) return;

        // Render User Msg
        let html = text;
        if(fileIn.files[0]) html += `<br><i>[File: ${fileIn.files[0].name}]</i>`;
        
        const div = document.createElement('div');
        div.className = 'msg user';
        div.innerHTML = `<div class="bubble">${html}</div>`;
        chatBox.insertBefore(div, document.getElementById('typing'));
        
        input.value = '';
        document.getElementById('typing').style.display = 'flex';
        chatBox.scrollTop = chatBox.scrollHeight;

        const fd = new FormData();
        fd.append('user_input', text);
        if(fileIn.files[0]) fd.append('file', fileIn.files[0]);
        fileIn.value = '';

        try {
            const res = await fetch('{{ endpoint }}', { method:'POST', body:fd });
            const data = await res.json();
            document.getElementById('typing').style.display = 'none';
            
            const botDiv = document.createElement('div');
            botDiv.className = 'msg assistant';
            // Backend đã trả về text sạch (không có JSON), dùng innerHTML để hiện đậm/nghiêng
            botDiv.innerHTML = `<div class="bubble">${data.response}</div>`;
            chatBox.insertBefore(botDiv, document.getElementById('typing'));
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch {
            document.getElementById('typing').style.display = 'none';
        }
    };

    // Timer logic
    let start = localStorage.getItem('s_start') || Date.now();
    localStorage.setItem('s_start', start);
    setInterval(() => {
        let s = Math.floor((Date.now()-start)/1000);
        let h = Math.floor(s/3600).toString().padStart(2,'0');
        let m = Math.floor((s%3600)/60).toString().padStart(2,'0');
        let sec = (s%60).toString().padStart(2,'0');
        document.getElementById('timer').innerText = `${h}:${m}:${sec}`;
    }, 1000);
</script>
{% endblock %}
